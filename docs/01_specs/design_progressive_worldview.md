# 渐进式世界观产品设计文档 (Product Design Doc: Progressive Worldview)

## 1. 核心愿景 (Core Vision)

**“不仅仅是阅读，而是见证世界的重构。”**

StoryTrace 的渐进式世界观模块旨在打破传统百科的静态与剧透属性，通过模拟人类认知的局限性与成长性，为读者提供一种**“迷雾中探索真相”**的沉浸式体验。我们将世界观不仅仅视为背景设定，而是视为叙事的一部分——**世界观本身就是主角**。

---

## 2. 架构设计与实现 (Architecture & Implementation)

### 2.1 双层存储模型 (Two-Tier Storage Model)
*   **Entity Chronicle (一级缓存)**：
    *   在 Ingestion 阶段生成，记录实体在每一章的原始描述片段。
    *   **作用**：作为后续高级分析的“最小化上下文 (Minimal Context)”，极大降低 LLM 读取原文的 Token 成本。
*   **Concept Evolution (二级缓存)**：
    *   按需触发，存储在 Entity 属性中。
    *   **结构**：`List[ConceptStage]` (Unknown -> Rumor -> Fact -> Truth)。
    *   **策略**：**全量替换 (Full Replacement)**。每次分析都会清空旧的历史数据，确保展示的是最新、最干净的认知演变路径。

### 2.2 按需分析引擎 (On-Demand Analysis Engine)
*   **触发机制**：用户点击前端按钮 -> 后端 API (`POST /analyze/concept`)。
*   **幂等性设计 (Idempotency)**：
    *   **智能复用**：如果实体已有分析数据且未请求强制刷新，后端直接返回现有数据，**Token 消耗为 0**。
    *   **强制重构**：提供 `force=true` 选项，用于清除旧数据并重新调用 LLM 进行深度分析。
*   **数据清洗**：在保存新结果前，自动扫描并清除该实体在所有章节中的陈旧演变数据，防止数据无限追加导致的臃肿与混乱。

---

## 3. 交互设计：图谱节点弹窗 (Graph Popover UX)

基于 `ConceptEvolutionCard` 组件的实战开发经验，我们确立了以下交互规范：

### 3.1 状态驱动的 UI (State-Driven UI)
*   **空状态 (Empty State)**：
    *   **表现**：灰色背景，提示“暂无概念演变分析数据”。
    *   **行动**：主按钮显示“**分析概念演变**”，引导用户开启探索。
    *   **修复经验**：移除了前端的 `v-if` 渲染锁，确保即使是未分析过的节点也能显示卡片，避免了“没有数据就无法生成数据”的死循环。
*   **有数据状态 (Data State)**：
    *   **表现**：根据当前阶段（Truth/Fact/Rumor）显示对应的色调背景（紫/蓝/黄）。
    *   **Header**：醒目展示**最新认知阶段**（Latest Stage）。
    *   **List**：**倒序排列**（最新在上，最初在下），符合用户“先看结论，再溯源头”的阅读习惯。
    *   **行动**：主按钮显示“**刷新/补全**”（秒回），并在右侧提供隐藏的**红色强制刷新按钮**（带确认弹窗）。

### 3.2 渐进式揭示 (Progressive Disclosure)
*   **默认折叠**：仅展示当前阶段标签与核心描述。
*   **展开详情**：点击后展示完整的历史演变轨迹（History Trace），每个节点包含阶段名与当时的认知描述。

### 3.3 反馈与防误触 (Feedback & Safety)
*   **加载状态**：使用脉冲动画替代简单的 Spinner，提示“分析中...”，缓解用户等待焦虑。
*   **成本警示**：对于消耗 Token 的强制刷新操作，必须弹出 `confirm` 对话框，明确告知用户后果。

---

## 4. 未来演进规划 (Future Roadmap)

### 4.1 视觉隐喻升级
*   **认知仪表盘**：在卡片右上角增加微型仪表盘，指针随剧情发展从“存疑”摆向“确信”。
*   **动态高亮**：在历史描述中，自动高亮与当前认知冲突的关键词（如 ~~是政府机构~~ -> **是跨国财团**）。

### 4.2 深度沉浸空间：独立世界观标签页 (Worldview Tab)
*   **定位**：作为与“概览”、“图谱”并列的第三个顶级功能标签，提供全景式的世界观探索体验。
*   **迷雾系统**：未读章节区域被动态迷雾覆盖，随着阅读进度推进，迷雾逐渐散去，露出隐藏的设定。
*   **多维泳道**：将世界观分为“政治”、“科技”、“神话”等并行泳道，清晰展示不同领域的同步演变。
*   **线索连线**：用户可以手动开启“侦探模式”，看到不同线索点之间的**红线连接**，揭示因果关系（如：A 的身份揭露导致了 B 的组织性质变更）。

---

## 5. 总结
StoryTrace 的渐进式世界观模块已完成从“静态展示”到“动态交互”的跨越。通过**按需分析、幂等缓存、全量替换**的三位一体架构，我们在保证用户体验流畅性的同时，将 LLM 成本控制在了极低水平。这不仅仅是一个功能模块，更是 StoryTrace “活的数据库”理念的最佳实践。
