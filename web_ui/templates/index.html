<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryTrace Visualization</title>
    <!-- Local libraries -->
    <script src="/static/libs/vue.global.prod.js"></script>
    <script src="/static/libs/tailwindcss.js"></script>
    <script src="/static/libs/vis-network.min.js"></script>
    <style>
        .highlight-span {
            background-color: #fef08a; /* yellow-200 */
            transition: background-color 0.5s;
        }
        .active-span {
            background-color: #facc15; /* yellow-400 */
            font-weight: bold;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">
    <div id="app" class="h-full flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm px-6 py-4 flex items-center justify-between z-10">
            <h1 class="text-xl font-bold text-indigo-600 flex items-center gap-2">
                <span>üìö</span> StoryTrace
            </h1>
            
            <div class="flex gap-4 items-center">
                <!-- Novel Selector -->
                <select v-model="selectedNovel" @change="fetchRuns" class="border rounded px-2 py-1 text-sm">
                    <option :value="null" disabled>ÈÄâÊã©Â∞èËØ¥</option>
                    <option v-for="n in novels" :key="n.name" :value="n">{{ n.name }}</option>
                </select>
                
                <!-- Run/Version Selector -->
                <select v-model="selectedRun" @change="fetchChapters" class="border rounded px-2 py-1 text-sm" :disabled="!selectedNovel">
                    <option :value="null" disabled>ÈÄâÊã©ÁâàÊú¨</option>
                    <option v-for="r in runs" :key="r.timestamp" :value="r">{{ formatTime(r.timestamp) }}</option>
                </select>
                
                <!-- Mode Selector -->
                <div class="flex bg-gray-100 rounded-lg p-1" v-if="selectedRun">
                    <button 
                        @click="showOverview" 
                        class="px-3 py-1 text-sm rounded-md transition-all"
                        :class="viewMode === 'overview' ? 'bg-white text-indigo-600 shadow-sm font-medium' : 'text-gray-500 hover:text-gray-700'"
                    >
                        üìö Ê¶ÇËßà
                    </button>
                    <button 
                        @click="viewMode = 'focus'" 
                        class="px-3 py-1 text-sm rounded-md transition-all"
                        :class="viewMode === 'focus' ? 'bg-white text-indigo-600 shadow-sm font-medium' : 'text-gray-500 hover:text-gray-700'"
                    >
                        üìñ ‰∏ìÊ≥®
                    </button>
                    <button 
                        @click="viewMode = 'encyclopedia'" 
                        class="px-3 py-1 text-sm rounded-md transition-all"
                        :class="viewMode === 'encyclopedia' ? 'bg-white text-indigo-600 shadow-sm font-medium' : 'text-gray-500 hover:text-gray-700'"
                    >
                        üåè ÁôæÁßë
                    </button>
                    <button 
                        @click="viewMode = 'graph'" 
                        class="px-3 py-1 text-sm rounded-md transition-all"
                        :class="viewMode === 'graph' ? 'bg-white text-indigo-600 shadow-sm font-medium' : 'text-gray-500 hover:text-gray-700'"
                    >
                        üï∏Ô∏è ÂõæË∞±
                    </button>
                </div>

                <!-- Chapter Selector -->
                <select v-model="selectedChapterId" @change="fetchChapterDetail" class="border rounded px-2 py-1 text-sm" :disabled="!selectedRun">
                    <option :value="null" disabled>ÈÄâÊã©Á´†ËäÇ</option>
                    <option v-for="c in chapters" :key="c.id" :value="c.id">{{ c.title }}</option>
                </select>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex overflow-hidden relative">
            <!-- Debug Info Overlay -->
            <div class="fixed bottom-0 right-0 bg-black text-white p-2 text-xs z-50 max-h-64 w-64 overflow-auto opacity-90">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold">Debug Info</span>
                    <button @click="runDebug" class="bg-red-500 hover:bg-red-600 px-2 py-1 rounded text-[10px]">Run Check</button>
                </div>
                <pre class="whitespace-pre-wrap font-mono text-[10px]">{{ debugOutput }}</pre>
            </div>

            <div v-if="loading" class="absolute inset-0 flex items-center justify-center bg-white/50 z-50">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
            </div>

            <div v-if="!currentChapter && viewMode !== 'graph'" class="w-full flex items-center justify-center text-gray-400">
                ËØ∑ÈÄâÊã©Á´†ËäÇ‰ª•ÂºÄÂßãÈòÖËØª
            </div>

            <template v-else-if="viewMode === 'graph'">
                <!-- Graph View Container -->
                <div class="flex-1 flex flex-col relative bg-gray-50">
                    <div class="absolute inset-0 z-0" id="graph-container"></div>
                    
                    <!-- Graph Controls Overlay -->
                    <div class="absolute top-4 left-4 z-10 bg-white/90 p-4 rounded shadow backdrop-blur-sm max-w-sm">
                        <h2 class="font-bold text-gray-700 mb-2">ÂÖ®‰π¶ÂÖ≥Á≥ªÂõæË∞±</h2>
                        
                        <div v-if="graphLoading" class="text-sm text-gray-500 flex items-center gap-2">
                            <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-indigo-600"></div>
                            Ê≠£Âú®Âä†ËΩΩÂõæË∞±Êï∞ÊçÆ...
                        </div>
                        
                        <div v-else>
                            <div class="mb-4">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="block text-xs text-gray-500">Êó∂Èó¥ËΩ¥ (Á´†ËäÇ)</label>
                                    <span class="font-bold text-indigo-600 text-sm">{{ currentTimelineChapter ? currentTimelineChapter.title : '' }}</span>
                                </div>
                                <input 
                                    type="range" 
                                    min="0" 
                                    :max="chapters.length - 1" 
                                    v-model.number="timelineIndex"
                                    @input="updateGraphFilter"
                                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                >
                                <div class="flex justify-between text-[10px] text-gray-400 mt-1 select-none">
                                    <span 
                                        v-for="(label, idx) in timelineLabels" 
                                        :key="idx"
                                        :class="{'invisible': label.text === ''}"
                                    >
                                        {{ label.text }}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Filter Mode Toggle -->
                            <div class="flex bg-gray-100 rounded p-1 mb-4">
                                <button 
                                    class="flex-1 py-1 text-xs rounded transition-colors"
                                    :class="graphFilterMode === 'cumulative' ? 'bg-white shadow text-indigo-600 font-medium' : 'text-gray-500 hover:text-gray-700'"
                                    @click="setGraphFilterMode('cumulative')"
                                >
                                    ÂÖ®Â±ÄÁ¥ØËÆ°
                                </button>
                                <button 
                                    class="flex-1 py-1 text-xs rounded transition-colors"
                                    :class="graphFilterMode === 'focus' ? 'bg-white shadow text-indigo-600 font-medium' : 'text-gray-500 hover:text-gray-700'"
                                    @click="setGraphFilterMode('focus')"
                                >
                                    ÂçïÁ´†‰∏ìÊ≥®
                                </button>
                            </div>

                            <!-- Advanced Filters (Only in Cumulative Mode) -->
                            <div v-if="graphFilterMode === 'cumulative'" class="mb-4 space-y-3 border-t pt-3">
                                <!-- Min Weight Slider -->
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="text-xs text-gray-500">ÊúÄÂ∞ë‰∫íÂä®Ê¨°Êï∞</label>
                                        <span class="font-bold text-indigo-600 text-xs">{{ minGraphWeight }}</span>
                                    </div>
                                    <input 
                                        type="range" 
                                        min="1" 
                                        max="10" 
                                        v-model.number="minGraphWeight"
                                        @input="updateGraphFilter"
                                        class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                    >
                                </div>

                                <!-- Entity Types -->
                                <div>
                                    <label class="block text-xs text-gray-500 mb-1">ÊòæÁ§∫ÂÆû‰ΩìÁ±ªÂûã</label>
                                    <div class="grid grid-cols-2 gap-1">
                                        <label v-for="type in availableEntityTypes" :key="type" class="flex items-center gap-1 cursor-pointer">
                                            <input 
                                                type="checkbox" 
                                                :value="type" 
                                                v-model="visibleEntityTypes"
                                                @change="updateGraphFilter"
                                                class="w-3 h-3 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300"
                                            >
                                            <span class="text-[10px] text-gray-600">{{ type }}</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- View Controls -->
                            <div class="flex justify-end mb-2">
                                <button 
                                    @click="fitGraph" 
                                    class="text-xs bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 px-2 py-1 rounded shadow-sm flex items-center gap-1 transition-colors"
                                    title="ÈÄÇÈÖçÂ±èÂπï"
                                >
                                    <span>‚õ∂</span> ÈÄÇÈÖçËßÜÂõæ
                                </button>
                            </div>

                            <div class="text-xs text-gray-500 space-y-1">
                                <p>ËäÇÁÇπÊï∞Èáè: {{ graphStats.nodes }}</p>
                                <p>ÂÖ≥Á≥ªÊï∞Èáè: {{ graphStats.edges }}</p>
                                <p class="text-[10px] text-gray-400 mt-2">
                                    ÊèêÁ§∫: ÊãñÂä®ÊªëÂùóÊü•ÁúãÂÖ≥Á≥ªÊºîÂèò„ÄÇ
                                    ÂèåÂáªËäÇÁÇπÂèØÊü•ÁúãÂÆû‰ΩìËØ¶ÊÉÖ„ÄÇ
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Legend Overlay -->
                    <div class="absolute bottom-4 left-4 z-10 bg-white/90 p-3 rounded shadow backdrop-blur-sm text-xs">
                        <h3 class="font-bold text-gray-600 mb-2">Âõæ‰æã</h3>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                            <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-yellow-400 border border-yellow-600"></span> Person (‰∫∫Áâ©)</div>
                            <div class="flex items-center gap-2"><span class="w-3 h-3 bg-blue-400 border border-blue-600"></span> Location (Âú∞ÁÇπ)</div>
                            <div class="flex items-center gap-2"><span class="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-b-[10px] border-b-purple-400"></span> Org (ÁªÑÁªá)</div>
                            <div class="flex items-center gap-2"><span class="w-3 h-3 rotate-45 bg-green-400 border border-green-600"></span> Item (Áâ©ÂìÅ)</div>
                            <div class="flex items-center gap-2"><span class="w-3 h-3 bg-pink-400 border border-pink-600 clip-star">‚òÖ</span> Concept (Ê¶ÇÂøµ)</div>
                        </div>
                    </div>
                </div>
            </template>

            <template v-else>
                <!-- Left: Summary Pane / Overview Grid -->
                <div 
                    class="bg-gray-50 border-r border-gray-200 flex flex-col overflow-auto transition-all duration-300"
                    :class="viewMode === 'overview' ? 'w-full' : 'w-1/3 min-w-[300px] max-w-[600px] resize-x'"
                >
                    <!-- Overview Mode: Chapter List -->
                    <template v-if="viewMode === 'overview'">
                        <div class="p-4 border-b bg-white sticky top-0 z-10 flex justify-between items-center">
                            <div>
                                <h2 class="font-semibold text-gray-700">ÂÖ®‰π¶Ê¶ÇËßà</h2>
                                <p class="text-xs text-gray-400 mt-1">ÁÇπÂáªÂç°ÁâáÊü•ÁúãËØ¶ÊÉÖÔºåÊàñÁÇπÂáªÁ≤æËØªËøõÂÖ•ÈòÖËØªÊ®°Âºè</p>
                            </div>
                            <div class="text-xs text-gray-500">
                                ÂÖ± {{ chapters.length }} Á´†
                            </div>
                        </div>
                        <div class="p-4 overflow-y-auto flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 auto-rows-max content-start">
                            <div 
                                v-for="chap in chapters" 
                                :key="chap.id"
                                :id="'card-' + chap.id"
                                @click="enterIntensiveReading(chap.id)"
                                class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:border-indigo-400 hover:shadow-md cursor-pointer transition-all group flex flex-col h-full"
                                :class="{'ring-2 ring-indigo-400 bg-indigo-50': selectedChapterId === chap.id}"
                            >
                                <div class="flex justify-between items-start mb-3">
                                    <h3 class="font-bold text-gray-800 text-base group-hover:text-indigo-700 line-clamp-1" :title="chap.title">{{ chap.title }}</h3>
                                    <span class="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full whitespace-nowrap">ID: {{ chap.id }}</span>
                                </div>
                                <div class="flex-1 mb-3">
                                    <p class="text-sm text-gray-600 leading-relaxed line-clamp-4" v-if="chap.headline">
                                        {{ chap.headline }}
                                    </p>
                                    <p class="text-sm text-gray-400 italic" v-else>
                                        (ÊöÇÊó†Ê†∏ÂøÉÊÄªÁªì)
                                    </p>
                                </div>
                                <div class="mt-auto pt-3 border-t border-gray-100 flex justify-end">
                                    <button 
                                        @click.stop="enterIntensiveReading(chap.id)"
                                        class="text-xs bg-indigo-50 hover:bg-indigo-100 text-indigo-600 hover:text-indigo-800 px-3 py-1.5 rounded-full transition-colors font-medium flex items-center gap-1"
                                    >
                                        ÂºÄÂßãÁ≤æËØª &rarr;
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Focus Mode: Detailed Summary -->
                    <template v-else-if="viewMode === 'focus'">
                        <div class="p-4 border-b bg-white sticky top-0 z-10 flex justify-between items-center">
                            <h2 class="font-semibold text-gray-700">Êô∫ËÉΩÊÄªÁªì</h2>
                            <button @click="viewMode = 'overview'" class="text-xs text-indigo-600 hover:underline">ËøîÂõûÊ¶ÇËßà</button>
                        </div>
                        <div class="p-4 space-y-4 overflow-y-auto flex-1">
                            <div v-if="currentChapter.summary_sentences.length === 0" class="text-gray-500 italic text-sm">
                                Êú¨Á´†ÊöÇÊó†ÊÄªÁªìÊï∞ÊçÆ„ÄÇ
                            </div>
                            <div 
                                v-for="(sent, idx) in currentChapter.summary_sentences" 
                                :key="idx"
                                @click="scrollToSpan(sent.source_spans)"
                                class="bg-white p-3 rounded shadow-sm border border-gray-100 hover:border-indigo-300 hover:shadow-md cursor-pointer transition-all group"
                                :class="{'ring-2 ring-indigo-400': activeSummaryIndex === idx}"
                            >
                                <p class="text-gray-700 text-sm leading-relaxed group-hover:text-indigo-900">
                                    {{ sent.summary_text }}
                                </p>
                                <div class="mt-2 flex gap-2" v-if="sent.source_spans && sent.source_spans.length > 0">
                                    <span class="text-xs bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded">
                                        ÂéüÊñáÊ∫ØÊ∫ê
                                    </span>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Encyclopedia Mode: Entity List -->
                    <template v-else-if="viewMode === 'encyclopedia'">
                        <div class="p-4 border-b bg-white sticky top-0 z-10">
                            <div class="flex justify-between items-center mb-2">
                                <h2 class="font-semibold text-gray-700">ÁôæÁßë</h2>
                                <button @click="viewMode = 'overview'" class="text-xs text-indigo-600 hover:underline">ËøîÂõûÊ¶ÇËßà</button>
                            </div>
                            
                            <!-- Scope Toggle -->
                            <div class="flex bg-gray-100 rounded p-1 mb-2">
                                <button 
                                    class="flex-1 py-1 text-xs rounded transition-colors"
                                    :class="entityScope === 'chapter' ? 'bg-white shadow text-indigo-600 font-medium' : 'text-gray-500 hover:text-gray-700'"
                                    @click="setEntityScope('chapter')"
                                >
                                    Êú¨Á´†
                                </button>
                                <button 
                                    class="flex-1 py-1 text-xs rounded transition-colors"
                                    :class="entityScope === 'book' ? 'bg-white shadow text-indigo-600 font-medium' : 'text-gray-500 hover:text-gray-700'"
                                    @click="setEntityScope('book')"
                                >
                                    ÂÖ®‰π¶
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-4 space-y-6 overflow-y-auto flex-1">
                            <div v-if="entityScope === 'chapter' && (!currentChapter.entities || currentChapter.entities.length === 0)" class="text-gray-500 italic text-sm">
                                Êú¨Á´†ÊöÇÊó†ÂÆû‰ΩìÊï∞ÊçÆ„ÄÇ
                            </div>
                            <div v-else-if="entityScope === 'book' && Object.keys(groupedEntities).length === 0" class="text-gray-500 italic text-sm">
                                ÂÖ®‰π¶ÊöÇÊó†ÂÆû‰ΩìÊï∞ÊçÆ„ÄÇ
                            </div>
                            
                            <template v-else>
                                <div v-for="(group, type) in groupedEntities" :key="type">
                                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 sticky top-0 bg-gray-50 py-1">{{ type }}</h3>
                                    <div class="space-y-2">
                                        <div 
                                            v-for="ent in group" 
                                            :key="ent.name"
                                            class="bg-white p-3 rounded shadow-sm border border-gray-100 group hover:border-indigo-300 transition-all"
                                        >
                                            <div class="flex items-center justify-between mb-1">
                                                <span class="font-bold text-gray-800 text-sm">{{ ent.name }}</span>
                                                <span v-if="ent.count" class="text-xs bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-full">
                                                    {{ ent.count }}Ê¨°
                                                </span>
                                            </div>
                                            <p class="text-xs text-gray-600 leading-relaxed line-clamp-3 group-hover:line-clamp-none transition-all">
                                                {{ ent.description }}
                                            </p>
                                            
                                            <!-- Show appearance chapters if available (only in book mode usually) -->
                                            <div v-if="ent.chapter_ids && ent.chapter_ids.length > 0 && entityScope === 'book'" class="mt-2 pt-2 border-t border-gray-50 hidden group-hover:block">
                                                <p class="text-[10px] text-gray-400 mb-1">ÁôªÂú∫Á´†ËäÇ:</p>
                                                <div class="flex flex-wrap gap-1">
                                                    <span 
                                                        v-for="cid in ent.chapter_ids.slice(0, 5)" 
                                                        :key="cid"
                                                        class="text-[10px] bg-indigo-50 text-indigo-600 px-1 rounded cursor-pointer hover:bg-indigo-100"
                                                        @click.stop="enterIntensiveReading(cid)"
                                                    >
                                                        {{ cid }}
                                                    </span>
                                                    <span v-if="ent.chapter_ids.length > 5" class="text-[10px] text-gray-400">
                                                        +{{ ent.chapter_ids.length - 5 }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- Right: Source Text Pane -->
                <div class="flex-1 bg-white flex flex-col min-w-[400px]" v-if="viewMode !== 'overview'">
                    <div class="p-4 border-b sticky top-0 bg-white z-10 flex justify-between items-center">
                        <h2 class="font-bold text-lg text-gray-800">{{ currentChapter.title }}</h2>
                        <span class="text-xs text-gray-400">ID: {{ currentChapter.id }}</span>
                    </div>
                    
                    <div 
                        id="source-content" 
                        class="flex-1 p-8 overflow-y-auto font-serif text-lg leading-loose text-gray-800 whitespace-pre-wrap"
                        ref="sourceContainer"
                    >
                        <!-- Content will be injected here with span tags -->
                        <div v-html="highlightedContent"></div>
                    </div>
                </div>
            </template>
        </main>
    </div>

    <script type="module" src="/static/js/app.js?v=2"></script>
</body>
</html>